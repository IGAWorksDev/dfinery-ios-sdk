푸시, 알림톡, 문자, 인앱메시지와 같은 Dfinery의 액션 기능을 사용하기 위한 iOS SDK 연동 가이드입니다. 
## 시작하기 전에
[유저 속성 정보](./유저%20속성%20정보.md) 설정을 통해 사용하고자 하는 액션의 채널 수신 동의 설정이 선행되어야 합니다.

### 유저 속성 정보 설정
| 상수명 | 설명 |
| --- | --- |
| DF.USER_PUSH | 푸시 수신 동의 |
| DF.USER_PUSH_ADS | 푸시 수신 동의 (광고) |
| DF.USER_KAKAO_ADS | 카카오 친구톡 수신 동의 (광고) |
| DF.USER_SMS_ADS | 문자 수신 동의 (광고) |
| DF.USER_PUSH_ADS_NIGHT | 야간 푸시 수신 동의(광고) |
| | |


```objective-c
[[Dfinery shared] setUserProfileForKey:DF.USER_PUSH value:@YES];
[[Dfinery shared] setUserProfileForKey:DF.USER_PUSH_ADS value:@YES];

//or

[[Dfinery shared] setUserProfileWithDict:@{
    DF.USER_PUSH: @YES,
    DF.USER_PUSH_ADS: @YES,
    DF.USER_PUSH_ADS_NIGHT: @NO,
    DF.USER_KAKAO_ADS: @YES,
    DF.USER_SMS_ADS: @YES
}];
```
>[!NOTE]
> DF.USER_PUSH(푸시 수신 동의) 외 항목들의 기본 설정값은 false 입니다.

# 푸시
## 시작하기 전에
푸시메시지를 사용하기 위해 Appple로부터 발급받은 .p8 APNs 인증키를 콘솔에 등록해주세요

## SDK 연동

### 유저 속성 정보 설정
[유저 속성 정보](./유저%20속성%20정보.md) 설정을 통해 채널 수신 동의 설정이 선행되어야 합니다.
| 상수명 | 설명 |
| --- | --- |
| DF.USER_PUSH | 푸시 수신 동의 |
| DF.USER_PUSH_ADS | 푸시 수신 동의 (광고) |
| DF.USER_PUSH_ADS_NIGHT | 야간 푸시 수신 동의(광고) |

```objective-c
[[Dfinery shared] setUserProfileForKey:DF.USER_PUSH value:@YES];
[[Dfinery shared] setUserProfileForKey:DF.USER_PUSH_ADS value:@YES];
[[Dfinery shared] setUserProfileForKey:DF.USER_PUSH_ADS_NIGHT value:@NO];

//or

[[Dfinery shared] setUserProfileWithDict:@{
    DF.USER_PUSH: @YES,
    DF.USER_PUSH_ADS: @YES,
    DF.USER_PUSH_ADS_NIGHT: @NO
}];
```
>[!NOTE]
> DF.USER_PUSH(푸시 수신 동의) 외 항목들의 기본 설정값은 false 입니다.

### AppDelegate 클래스에 디바이스 토큰 등록 코드를 추가합니다.                                                            
AppDelegate.h 파일에 필요한 헤더파일을 선언하고 UNUserNotificationCenterDelegate를 연동합니다.
```objective-c
#import <UIKit/UIKit.h>
#import <DfinerySDK/DfinerySDK.h>
#import <UserNotifications/UserNotifications.h>

@interface AppDelegate : UIResponder <UIApplicationDelegate, UNUserNotificationCenterDelegate>

@end

```
AppDelegate.m
```objective-c
#import <UIKit/UIKit.h>
#import <DfinerySDK/DfinerySDK.h>
#import <UserNotifications/UserNotifications.h>

@interface AppDelegate : UIResponder <UIApplicationDelegate, UNUserNotificationCenterDelegate>

@end

@implementation AppDelegate

- (BOOL)application:(UIApplication *)application didFinishLaunchingWithOptions:(NSDictionary *)launchOptions {
    ...
    [application registerForRemoteNotifications];
    ...
    return YES;
}

- (void)application:(UIApplication *)application didRegisterForRemoteNotificationsWithDeviceToken:(NSData *)deviceToken {
    [[Dfinery shared] setDeviceToken:deviceToken];
}

- (void)application:(UIApplication *)application didFailToRegisterForRemoteNotificationsWithError:(NSError *)error {
    NSLog(@"Failed to register for remote notifications: %@", error);
}

@end

```
> [!WARNING] 
> 푸시 메시지 사용을 위해 사용자 권한을 획득해야 합니다.  
> 예시 코드
> ```objective-c
> [[UNUserNotificationCenter currentNotificationCenter] requestAuthorizationWithOptions:(UNAuthorizationOptionAlert | UNAuthorizationOptionSound)
>              completionHandler:^(BOOL granted, NSError * _Nullable error) {
>                  if (granted) {
>                      dispatch_async(dispatch_get_main_queue(), ^{
>                          [[UIApplication sharedApplication] registerForRemoteNotifications];
>                      });
>                  }
>              }];
> ```

## 푸시 핸들링

푸시 핸들링을 위해 AppdDelegate 클래스에 UNUserNotificationCenterDelegate 프로토콜을 채택하고 SDK 코드를 연동해주세요.

AppDelegate.h
```objective-c
#import <UserNotifications/UserNotifications.h>

@interface AppDelegate : UIResponder <UIApplicationDelegate, UNUserNotificationCenterDelegate>
```

AppDelegate.m

```objective-c

- (BOOL)application:(UIApplication *)application didFinishLaunchingWithOptions:(NSDictionary *)launchOptions {
    ...
    ...
    [[UNUserNotificationCenter currentNotificationCenter] setDelegate:self];
    ...
    ...
}

- (void)userNotificationCenter:(UNUserNotificationCenter *)center didReceiveNotificationResponse:(UNNotificationResponse *)response withCompletionHandler:(void (^)(void))completionHandler
{
    if ([[Dfinery shared] canHandleNotificationWithResponse:response]) {
        completionHandler();
        return;
    }
}

- (void)userNotificationCenter:(UNUserNotificationCenter *)center willPresentNotification:(UNNotification *)notification withCompletionHandler:(void (^)(UNNotificationPresentationOptions))completionHandler
{
    if ([[Dfinery shared] canHandleForeground:notification completionHandler:completionHandler]) {
        return;
    }
}
```

## Service Extension
디파이너리 푸시의 이미지, 버튼 사용을 위해 Notification Service Extension을 추가로 생성하고 DfineryServiceExtension을 연동해야 합니다.

프레임웍 연동

```objective-c
#import "NotificationService.h"
#import <DfinerySDKServiceExtension/DfinerySDKServiceExtension.h>
...
...
- (void)didReceiveNotificationRequest:(UNNotificationRequest *)request withContentHandler:(void (^)(UNNotificationContent * _Nonnull))contentHandler {
    self.contentHandler = contentHandler;
    self.bestAttemptContent = [request.content mutableCopy];
    
    if (self.bestAttemptContent) {
        if ([DfineryServiceExtension canHandleWithContent:self.bestAttemptContent contentHandler:contentHandler]) {
            return;
        }
    }
    
    self.contentHandler(self.bestAttemptContent);
}
...
```
# 알림톡
### 유저 식별 정보 설정
알림톡 발신을 위해 [식별 정보](./식별%20정보.md) 중 카카오 ID를 설정해 주세요.

예시코드
```objective-c
[[Dfinery shared] setIdentityForKey:DF.IDENTITY_KAKAO_USER_ID value:KAKAO_ID];
```

# 문자
### 유저 식별 정보 설정
문자 발송을 위해 [식별 정보](./식별%20정보.md) 중 핸드폰 번호를 설정해 주세요.

예시코드
```objective-c
[[Dfinery shared] setIdentityForKey:DF.IDENTITY_PHONE_NO value:@"821012345678"];
```
> [!WARNING] 
> 전화번호의 경우 다음과 같은 형식으로 입력해주시기 바랍니다. ex) 821012345678, 82212345678

# 인앱메시지
SDK 연동 단계에서 부가 설정 없이 인앱메시지 사용이 가능합니다.