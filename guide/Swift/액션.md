푸시, 알림톡, 문자, 인앱메시지와 같은 Dfinery의 액션 기능을 사용하기 위한 iOS SDK 연동 가이드입니다. 

## 시작하기 전에
[유저 속성 정보](./유저%20속성%20정보.md) 설정을 통해 사용하고자 하는 액션의 채널 수신 동의 설정이 선행되어야 합니다.

### 유저 속성 정보 설정
| 상수명 | 설명 |
| --- | --- |
| DF.USER_PUSH | 푸시 수신 동의 |
| DF.USER_PUSH_ADS | 푸시 수신 동의 (광고) |
| DF.USER_KAKAO_ADS | 카카오 친구톡 수신 동의 (광고) |
| DF.USER_SMS_ADS | 문자 수신 동의 (광고) |
| DF.USER_PUSH_ADS_NIGHT | 야간 푸시 수신 동의(광고) |
| | |


```swift
Dfinery.shared().setUserProfile(key: DF.USER_PUSH, value: true)
Dfinery.shared().setUserProfile(key: DF.USER_PUSH_ADS, value: true)

//or

Dfinery.shared().set(userProfiles: [
    DF.USER_PUSH: true,
    DF.USER_PUSH_ADS: true,
    DF.USER_PUSH_ADS_NIGHT: false,
    DF.USER_KAKAO_ADS: true,
    DF.USER_SMS_ADS: true 
])
```
>[!NOTE]
> DF.USER_PUSH(푸시 수신 동의) 외 항목들의 기본 설정값은 false 입니다.

# 푸시
## 시작하기 전에
푸시메시지를 사용하기 위해 Appple로부터 발급받은 .p8 APNs 인증키를 콘솔에 등록해주세요

## SDK 연동

AppDelegate 클래스에 디바이스 토큰 등록 코드를 추가합니다.
```swift
import UIKit
import UserNotifications

import DfinerySDK

@main
class AppDelegate: UIResponder, UIApplicationDelegate {

    func application(_ application: UIApplication, didFinishLaunchingWithOptions launchOptions: [UIApplication.LaunchOptionsKey: Any]?) -> Bool {
        ...
        ...
        application.registerForRemoteNotifications()
        ...
        ...
    }

    func application(_ application: UIApplication, didRegisterForRemoteNotificationsWithDeviceToken deviceToken: Data) {
        
        Dfinery.shared().set(deviceToken: deviceToken)

    }

}
```
> [!WARNING] 
> 푸시 메시지 사용을 위해 사용자 권한을 획득해야 합니다.  
> 예시 코드
> ```swift
> UNUserNotificationCenter.current().requestAuthorization(options: [.alert, sound]) { granted, err in
>   if granted {
>       DispatchQueue.main.async {
>           UIApplication.shared.registerForRemoteNotifications()
>       }
>   }
> }
> ```

## 푸시 핸들링

푸시 핸들링을 위해 AppdDelegate 클래스에 UNUserNotificationCenterDelegate 프로토콜을 채택하고 SDK 코드를 연동해주세요.
```swift
class AppDelegate: UIResponder, UIApplicationDelegate, UNUserNotificationCenterDelegate {

    func application(_ application: UIApplication, didFinishLaunchingWithOptions launchOptions: [UIApplication.LaunchOptionsKey: Any]?) -> Bool {
        ...
        ...
        UNUserNotificationCenter.current().delegate = self
        ...
        ...
    }

    func userNotificationCenter(_ center: UNUserNotificationCenter, didReceive response: UNNotificationResponse, withCompletionHandler completionHandler: @escaping () -> Void) {
        
        if Dfinery.shared().canHandleNotification(response: response) {
            completionHandler()
            return
        }
        
    }
    
    func userNotificationCenter(_ center: UNUserNotificationCenter, willPresent notification: UNNotification, withCompletionHandler completionHandler: @escaping (UNNotificationPresentationOptions) -> Void) {

        if Dfinery.shared().canHandleForeground(notification, completionHandler: completionHandler) {
            return
        }
        
    }
}
```

## Service Extension
디파이너리 푸시의 이미지, 버튼 사용을 위해 Notification Service Extension을 추가로 생성하고 DfineryServiceExtension을 연동해야 합니다.


```swift
import UserNotifications

import DfinerySDKServiceExtension

class NotificationService: UNNotificationServiceExtension {

    var contentHandler: ((UNNotificationContent) -> Void)?
    var bestAttemptContent: UNMutableNotificationContent?

    override func didReceive(_ request: UNNotificationRequest, withContentHandler contentHandler: @escaping (UNNotificationContent) -> Void) {
        self.contentHandler = contentHandler
        bestAttemptContent = (request.content.mutableCopy() as? UNMutableNotificationContent)
        
        if let bestAttemptContent = bestAttemptContent {
            
            if DfineryServiceExtension.canHandle(content: bestAttemptContent, contentHandler: contentHandler) {
                return
            }
            
            contentHandler(bestAttemptContent)
        }
    }
    ...
}
```

# 알림톡
### 유저 식별 정보 설정
알림톡 발신을 위해 [식별 정보](./식별%20정보.md) 중 카카오 ID를 설정해 주세요.

예시코드
```swift
Dfinery.shared().setIdentity(key: DF.IDENTITY_KAKAO_USER_ID, value: "KAKAO_ID")
```

# 문자
### 유저 식별 정보 설정
문자 발송을 위해 [식별 정보](./식별%20정보.md) 중 핸드폰 번호를 설정해 주세요.

예시코드
```swift
Dfinery.shared().setIdentity(key: DF.IDENTITY_PHONE_NO, value: "821012345678")
```
> [!WARNING] 
> 전화번호의 경우 다음과 같은 형식으로 입력해주시기 바랍니다. ex) 821012345678, 82212345678

# 인앱메시지
SDK 연동 단계에서 부가 설정 없이 인앱메시지 사용이 가능합니다.